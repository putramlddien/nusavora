{% extends "base.html" %} {% block content %}
<script>
    function searchLocation() {
        let query = document.getElementById("manual-location").value;
        if (!query) {
            alert("Masukkan lokasi dulu!");
            return;
        }

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    let latitude = data[0].lat;
                    let longitude = data[0].lon;

                    console.log("Lokasi Manual:", latitude, longitude);
                    sendLocationToServer(latitude, longitude);
                } else {
                    alert("Lokasi tidak ditemukan!");
                }
            });
    }
</script>

<script>
  let timeout = null;
const input = document.getElementById("manual-location");
const suggestions = document.getElementById("location-suggestions");

input.addEventListener("input", function() {
    clearTimeout(timeout);
    const query = this.value;
    if (query.length < 2) {
        suggestions.innerHTML = "";
        return;
    }
    timeout = setTimeout(() => {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`)
            .then(res => res.json())
            .then(data => {
                suggestions.innerHTML = "";
                data.forEach(item => {
                    const li = document.createElement("li");
                    li.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer";
                    li.textContent = item.display_name;
                    li.onclick = () => {
                        input.value = item.display_name;
                        suggestions.innerHTML = "";
                        sendLocationToServer(item.lat, item.lon);
                    };
                    suggestions.appendChild(li);
                });
            });
    }, 300); // debounce
});

// Klik di luar suggestions untuk menutup
document.addEventListener("click", function(e) {
    if (!input.contains(e.target) && !suggestions.contains(e.target)) {
        suggestions.innerHTML = "";
    }
});
</script>

<div class="container pt-0 pb-8 md:pb-16 lg:pb-24 mx-auto">
  <section class="text-gray-600 body-font">
    <div
      class="container mx-auto flex px-5 py-24 md:flex-row flex-col items-center"
    >
      <div class="lg:max-w-lg lg:w-full md:w-1/2 w-5/6 mb-10 md:mb-0">
        <img
          src="https://v3.material-tailwind.com/gradient-pattern.jpg"
          alt="gradient pattern"
          class="w-full h-full rounded-xl"
        />
      </div>
      <div
        class="lg:flex-grow md:w-1/2 lg:pl-24 md:pl-16 flex flex-col md:items-start md:text-left items-center text-center"
      >
        <h1
          class="title-font sm:text-4xl text-3xl mb-4 font-medium text-gray-900"
        >
          Before they sold out <br class="hidden lg:inline-block" />readymade
          gluten
        </h1><br>
        <div class="flex items-center space-x-4 bg-gray-100 p-4 rounded-md">
    <p class="text-gray-700 font-medium">Pilih Lokasi Anda:</p>

    <button onclick="getCurrentLocation()" class="bg-blue-500 text-white px-3 py-2 rounded-md">
        Gunakan Lokasi Saat Ini
    </button>

     <div class="relative">
    <input type="text" id="manual-location" class="border p-2 rounded-md" placeholder="Masukkan lokasi" autocomplete="off">
    <ul id="location-suggestions" class="bg-white border rounded-md mt-1 absolute z-10 w-full"></ul>
    </div>
    <button onclick="searchLocation()" class="bg-green-500 text-white px-3 py-2 rounded-md">
        Cari
    </button>
</div>

<script>
    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                let latitude = position.coords.latitude;
                let longitude = position.coords.longitude;

                console.log("Lokasi User:", latitude, longitude);
                sendLocationToServer(latitude, longitude);
            });
        } else {
            alert("Browser tidak mendukung geolocation.");
        }
    }

    function sendLocationToServer(lat, lon) {
        fetch("/set-location/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ latitude: lat, longitude: lon })
        }).then(() => {
            loadVendorsByLocation(); // Refresh vendor list setelah lokasi diubah
        });
    }
</script>
      </div>
    </div>
  </section>

  <section class="text-gray-600 body-font">
    <div class="container px-5 py-15 mx-auto">
      <div
        class="flex flex-wrap w-full mb-1 flex-col items-center text-center">
        <h1 class="sm:text-3xl text-2xl font-medium title-font text-gray-900">
          What's good to eat in Location?
        </h1>
    <div class="container py-24 mx-auto">
      <div class="flex flex-wrap -m-4">
        <div id="vendor-list" class="flex flex-wrap -m-4">Memuat restoran...</div>
          <script>
              function loadVendorsByLocation() {
                  fetch("/get-vendors/")
                      .then(response => response.json())
                      .then(data => {
                          let vendorHTML = "";
                          data.vendors.forEach(vendor => {
                              vendorHTML += `<div class="lg:w-1/4 md:w-1/2 p-4 w-full">
                                  <a class="block relative h-48 rounded overflow-hidden">
                                      <img alt="" class="object-cover object-center w-full h-full block" src="https://example.com/default_vendor.jpg">
                                  </a>
                                  <div class="mt-4">
                                      <h3 class="text-gray-500 text-xs tracking-widest title-font mb-1">
                                          ${vendor.category}
                                      </h3>
                                      <h2 class="text-gray-900 title-font text-lg font-medium">
                                          ${vendor.name}
                                      </h2>
                                      <p class="mt-1">Jarak: ${vendor.distance}</p>
                                  </div>
                              </div>`;
                          });

                          document.getElementById("vendor-list").innerHTML = vendorHTML;
                      })
                      .catch(error => console.error("Gagal memuat restoran:", error));
              }

              window.onload = loadVendorsByLocation;
          </script>
      </div>
    </div>
  </section>
</div>

{% endblock %}